version: "3.7"
services:
  web:
    build:
      context: .
      dockerfile: web.dockerfile
    environment:
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=password
      - DB_NAME=app
      - DB_DRIVE=mysql+pymysql
      - CELERY_BROKER_URL=amqp://root:password@rabbitmq:5672/celery
      - SLACK_BOT_TOKEN=<bot-token>
      - SLACK_LOG_CHANNEL_ID=<channel-id>
    ports:
      - 8000:80
    depends_on:
      - mysql
      - rabbitmq
    networks:
      - mynet
  worker:
    build:
      context: .
      dockerfile: worker.dockerfile
    environment:
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=password
      - DB_NAME=app
      - DB_DRIVE=mysql+pymysql
      - CELERY_BROKER_URL=amqp://root:password@rabbitmq:5672/celery
      - CELERY_RESULT_PERSISTENT=1
    depends_on:
      - rabbitmq
      - mysql
    networks:
      - mynet
  flower:
    build:
      context: .
      dockerfile: flower.dockerfile
    environment:
      - CELERY_BROKER_URL=amqp://root:password@rabbitmq:5672/celery
      - BROKER_API=http://root:password@rabbitmq:15672/api/
    ports:
      - 5555:5555
    depends_on:
      - rabbitmq
    networks:
      - mynet
  mysql:
    image: mysql:5.5.61
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=app
    expose:
      - 3306
    ports:
      - 3306:3306
    networks:
      - mynet
  rabbitmq:
    image: rabbitmq:management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER=root
      - RABBITMQ_DEFAULT_PASS=password
      - RABBITMQ_DEFAULT_VHOST=celery
    expose:
      - 5672
      - 15672
    ports:
      - 15672:15672
    networks:
      - mynet
networks:
  mynet:
